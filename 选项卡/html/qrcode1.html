<!DOCTYPE html>
<html>

	<head lang="en">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta content="false" name="twcClient" id="twcClient">
		<meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
		<meta content="no-cache" http-equiv="pragma">
		<meta content="0" http-equiv="expires">
		<!--允许全屏模式-->
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<!--指定sari的样式-->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta content="telephone=no" name="format-detection" />
		<title>扫一扫</title>
		 <link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/default.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.poppicker.css" />
		<style type="text/css">
			.mui-content>.mui-table-view:first-child {
				margin-top: -1px;
			}
			
			#pullrefresh {
				overflow-x: hidden;
			}
			
			.click {
				text-align: center;
			}
			
			.mui-bar-nav {
				top: 0;
				-webkit-box-shadow: 0 1px 6px #ccc;
				box-shadow: 0 1px 6px #ccc;
			}
			
			.mui-bar {
				position: fixed;
				z-index: 999;
				right: 0;
				left: 0;
				height: 44px;
				padding-right: 10px;
				padding-left: 10px;
				border-bottom: 0;
				background-color: #f7f7f7;
				-webkit-box-shadow: 0 0 1px rgba(0, 0, 0, .85);
				box-shadow: 0 0 1px rgba(0, 0, 0, .85);
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
			}
			
			.mui-pull-right {
				float: right;
			}
			
			.mui-bar-footer {
				bottom: 0;
			}
			
			#bcid {
				width: 100%;
				height: 80%;
				position: absolute;
				top: 1rem;
				z-index: 1;
			}
			
			.fbt {
				color: #0E76E1;
				width: 50%;
				background-color: #ffffff;
				float: left;
				line-height: 44px;
				text-align: center;
			}
			
			html,
			body,
			#pullrefresh,
			.mui-content,
			.scanbox {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}
			.scanbox{
				position: fixed;
				left: 0;
				top: 0;
				z-index: 10000;
			}
			#pullrefresh {
				display: none;
			}
			
			.mui-content {
				background: url(../images/2.png) center no-repeat;
				background-size: 100% 100%;
			}
			
			.msg {
				padding: 20px 10px;
				line-height: 2;
				font-size: 3.5vw;
				color: #fff;
			}
			
			.gridBox ul,
			.gridBox ul li,
			.mui-media-body {
				background: none !important;
				border: none !important;
				color: #f8f8f8 !important;
			}
			
			.gridBox ul li a {
				padding: 4vw 0 !important;
				background: rgba(12, 66, 123, 0.35) !important;
				border-radius: 6px;
			}
			
			.getDeviceNo {
				margin-top: 20px;
			}
		</style>
	</head>

	<body>
		<div class="scanbox">
			<header class="mui-bar mui-bar-nav scan" style="background-color: #ffffff;">
				<span class="mui-pull-right" style="padding:.5rem 0;" id="turnTheLight">开灯</span>
			</header>
			<div class="scan">
				<div id="bcid">
					<!--盛放扫描控件的div-->
				</div>
			</div>

			<div class="mui-bar mui-bar-footer scan" style="padding: 0px;">
				<div class="fbt" onclick="scanPicture();">从相册选择二维码</div>
				<div class="fbt" onclick="scanClose();">取　 消</div>
			</div>
		</div>

		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<div class="mui-content">
					<div class="msg">
						Vending machine background system
						<br /> 售货机后台系统
						<br /> 高效 快捷 稳定
					</div>
					<div class="gridBox">
						<ul class="mui-table-view mui-grid-view mui-grid-9">
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4">
								<a href="">
									<span class="mui-icon mui-icon-home"></span>
									<div class="mui-media-body">货柜管理</div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4">
								<a href="">
									<span class="mui-icon mui-icon-email">
										<span class="mui-badge" style="display: none;">5</span>
									</span>
									<div class="mui-media-body">补货</div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-chatbubble"></span>
									<div class="mui-media-body">商品管理</div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-location"></span>
									<div class="mui-media-body">推送管理</div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-search"></span>
									<div class="mui-media-body"></div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-phone"></span>
									<div class="mui-media-body"></div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-gear"></span>
									<div class="mui-media-body"></div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="#">
									<span class="mui-icon mui-icon-info"></span>
									<div class="mui-media-body"></div>
								</a>
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-4" style="display: none;">
								<a href="view.html">
									<span class="mui-icon mui-icon-more"></span>
									<div class="mui-media-body"></div>
								</a>
							</li>
						</ul>
					</div>

					<div class="getDeviceNo">
						<!--<div class="mui-input-row">
					<label>设备号</label>
					<div id="deviceNo">

					</div>
				</div>-->
						<ul class="mui-table-view">
							<div class="mui-input-row mui-table-view-divider">
								<label>设备号：</label>
								<input type="hidden" class="mui-input-clear deviceType">
								<input type="text" class="mui-input-clear deviceNo" placeholder="请输入设备号或手动选取或直接扫描二维码">
							</div>
							<li class="mui-table-view-cell click">选取 </li>

						</ul>
					</div>

				</div>
			</div>

		</div>

	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/util.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/mui.poppicker.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						style: 'circle',
						callback: pulldownRefresh
					}
				}
			});

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				setTimeout(function() {
					console.log("正在刷新");
					jQuery(".deviceNo").val("");
					localStorage.removeItem("qrcode");
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					mui.toast("刷新成功。。。");
				}, 1500);
			}

			jQuery('body .gridBox li').click(function() {
				console.log(jQuery(this).index());
				switch(jQuery(this).index()) {
					case 0:
						mui.openWindow({
							url: 'pages/regulate.html',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							extras: {
								data: jQuery(".deviceNo").val(),
								type: jQuery(".deviceType").val()
							}
						});
						break;
					case 1:
						mui.openWindow({
							url: 'view.html',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							extras: {
								data: jQuery(".deviceNo").val(),
								type: jQuery(".deviceType").val()
							}
						});
						break;
					default:
						break;
				}
				//					document.location.href = this.href;

			});

			mui.plusReady(function() {
				
				//				plus.screen.lockOrientation("portrait-primary");				
				//				nav切换

				console.log("ready");

				mui('body').on('tap', '.scan', function() {
					mui.openWindow({
						url: 'qrcode.html',
						show: {
							aniShow: 'pop-in'
						},
						waiting: {
							autoShow: false
						},
						extras: {
							data: ""
						}
					});
				});
				//				获取扫码返回的二维码
				console.log(localStorage.getItem("qrcode"));
				var deviceData = localStorage.getItem("deviceData");
				console.log(deviceData);
				deviceData = JSON.parse(deviceData);
				var deviceNum = localStorage.getItem("qrcode");
				var timer = setInterval(function() {
					if(localStorage.getItem("qrcode")) {
						jQuery(".deviceNo").val(deviceNum);
						for(var i = 0; i < deviceData.length; i++) {
							for(var j = 0; j < deviceData[i].children.length; j++) {
								if(deviceNum == deviceData[i].children[j].value) {
									jQuery(".deviceType").val(deviceData[i].text)
								}
							}
						}
						localStorage.removeItem("qrcode")
					}
				}, 1500)

				jQuery(".click").click(function() {

					var picker = new mui.PopPicker({
						layer: 2
					});
					picker.setData(JSON.parse(localStorage.getItem("deviceData")))
					picker.pickers[0].setSelectedIndex(0, 1000);

					picker.show(function(SelectedItem) {
						console.log(JSON.stringify(SelectedItem[0]))
						var deviceType = SelectedItem[0].text;
						var deviceNo = SelectedItem[1].value;
						jQuery(".deviceNo").val(deviceNo)
						jQuery(".deviceType").val(deviceType)
					})
				})
			})
		</script>
	<script type="text/javascript">
		mui.init({
			beforeback: function() {　　 //获得父页面的webview
				var list = plus.webview.currentWebview().opener();　　 //触发父页面的自定义事件(refresh),从而进行刷新
				mui.fire(list, 'refresh1');
				//返回true,继续页面关闭逻辑
				return true;
			}
		});
		scan = null; //扫描对象
		mui.plusReady(function() { //通过mui初始化扫描

startRecognize();
			 //开始扫描
		});
		function startRecognize() { //开启扫描方法
			try {
				var filter;
				//自定义的扫描控件样式
				var styles = {
					frameColor: "#29E52C",
					scanbarColor: "#29E52C",
					background: ""
				}
				//扫描控件构造
				scan = new plus.barcode.Barcode('bcid', filter, styles);
				scan.onmarked = onmarked; ////扫描完毕后的回调
				scan.onerror = onerror; //扫描错误
				scan.start();

			} catch(e) {
				alert("出现错误啦:\n" + e);
			}
		};

		//打开关闭闪光灯处理
		var flag = false;
		document.getElementById("turnTheLight").addEventListener('tap', function() {
			if(flag == false) {
				scan.setFlash(true);
				flag = true;
			} else {
				scan.setFlash(false);
				flag = false;
			}
		});
		// 从相册中选择二维码图片
		function scanPicture() { //可以直接识别二维码图片
			plus.gallery.pick(function(path) {
				plus.barcode.scan(path, onmarked, function(error) {
					plus.nativeUI.alert("无法识别此图片");
				});
			}, function(err) {
				plus.nativeUI.alert("Failed: " + err.message);
			});
		}
		//这个是扫描二维码的回调函数，type是扫描二维码回调的类型
		function onmarked(type, result) {
			var text = '';
			switch(type) { //QR,EAN13,EAN8都是二维码的一种编码格式,result是返回的结果
				case plus.barcode.QR:
					text = 'QR: ';
					break;
				case plus.barcode.EAN13:
					text = 'EAN13: ';
					break;
				case plus.barcode.EAN8:
					text = 'EAN8: ';
					break;
			}
			scan.close();
			alert(result);
			result = result.slice(result.lastIndexOf("/") + 1);
			console.log(result);
			localStorage.setItem("qrcode", result);
			//			mui.back();

		};
		//关闭控件
		function scanClose() {
			jQuery(".scanbox").hide();
			jQuery("#pullrefresh").show();
			scan.close();
			//			var activePage = plus.webview.currentWebview()
			//			var targetPage = plus.webview.getWebviewById("html/device.html")
			//			util.changeSubpage(targetPage, activePage, 'pop-in');
			//			util.toggleNview(1)
			//			var index = plus.webview.getLaunchWebview();
			//						plus.webview.show(index);
			//			mui.back();
			//			plus.webview.currentWebview().hide()

		}
	</script>

</html>